name: Deploy to Production

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Install rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Stop service
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl stop rag-medicine-instructions || true && \
             sleep 3 && \
             sudo pkill -f 'streamlit.*8501' || true && \
             sleep 2"

      - name: Deploy code
        run: |
          # Create tar archive excluding unnecessary files
          tar --exclude='.git' \
              --exclude='.venv' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.env' \
              --exclude='storage' \
              --exclude='data' \
              --exclude='.DS_Store' \
              --exclude='*.ipynb_checkpoints' \
              --exclude='.cursor' \
              -czf /tmp/deploy.tar.gz .
          
          # Copy archive to server
          scp -o StrictHostKeyChecking=no /tmp/deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/deploy.tar.gz
          
          # Extract archive on server
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo mkdir -p /opt/rag-medicine-instructions && \
             cd /opt/rag-medicine-instructions && \
             sudo tar -xzf /tmp/deploy.tar.gz && \
             sudo chown -R rag-app:rag-app /opt/rag-medicine-instructions && \
             rm /tmp/deploy.tar.gz"
          
          # Clean up local archive
          rm /tmp/deploy.tar.gz

      - name: Install/update dependencies
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd /opt/rag-medicine-instructions && \
             sudo -u rag-app bash -c 'source .venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt'"

      - name: Set permissions and create Streamlit config
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo chown -R rag-app:rag-app /opt/rag-medicine-instructions && \
             sudo -u rag-app mkdir -p /opt/rag-medicine-instructions/.streamlit && \
             sudo -u rag-app touch /opt/rag-medicine-instructions/.streamlit/secrets.toml && \
             sudo -u rag-app touch /opt/rag-medicine-instructions/.streamlit/config.toml && \
             sudo chown -R rag-app:rag-app /opt/rag-medicine-instructions/.streamlit"

      - name: Start service
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl daemon-reload && \
             sudo systemctl start rag-medicine-instructions"

      - name: Wait for service to start
        run: |
          sleep 5

      - name: Check service status
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "sudo systemctl status rag-medicine-instructions --no-pager -l || true"

      - name: Health check
        run: |
          # Wait for Streamlit to fully start
          sleep 20
          # Check if service is running and port is accessible
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "if sudo systemctl is-active --quiet rag-medicine-instructions; then \
               echo '✅ Service is active'; \
               sleep 5; \
               if curl -s http://127.0.0.1:8501/_stcore/health > /dev/null; then \
                 echo '✅ Streamlit health check passed'; \
                 sudo systemctl status rag-medicine-instructions --no-pager -l | head -15; \
               else \
                 echo '⚠️  Service active but health check failed, checking logs...'; \
                 sudo journalctl -u rag-medicine-instructions --no-pager -n 30; \
                 exit 1; \
               fi; \
             else \
               echo '❌ Service failed to start'; \
               echo 'Service status:'; \
               sudo systemctl status rag-medicine-instructions --no-pager -l | head -30; \
               echo ''; \
               echo 'Recent logs:'; \
               sudo journalctl -u rag-medicine-instructions --no-pager -n 50; \
               echo ''; \
               echo 'Checking port 8501:'; \
               sudo lsof -i :8501 || echo 'Port 8501 is free'; \
               exit 1; \
             fi"

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View logs on server:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "sudo journalctl -u rag-medicine-instructions -f" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

